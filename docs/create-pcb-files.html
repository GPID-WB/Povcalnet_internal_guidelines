<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 11 Create .PCB files | PovcalNet Internal Guidelines and Protocols</title>
<meta name="author" content="PovcalNet team">
<meta name="author" content="Development Data Group">
<meta name="author" content="World Bank Group">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.6.3/header-attrs.js"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.3.9000/tabs.js"></script><script src="libs/bs3compat-0.2.3.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><link href="libs/vis-4.20.1/vis.css" rel="stylesheet">
<script src="libs/vis-4.20.1/vis.min.js"></script><script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="https://unpkg.com/tachyons@4/css/tachyons.min.css">
<link rel="stylesheet" href="css/style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">PovcalNet Internal Guidelines and Protocols</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> Introduction</a></li>
<li class="book-part">Basics</li>
<li><a class="" href="folder-structures.html"><span class="header-section-number">2</span> Folder Structures</a></li>
<li><a class="" href="collaboration-in-git.html"><span class="header-section-number">3</span> Collaboration in Git</a></li>
<li><a class="" href="stata-github.html"><span class="header-section-number">4</span> Stata and Github</a></li>
<li class="book-part">PovcalNet Update</li>
<li><a class="" href="intro-povcal.html"><span class="header-section-number">5</span> Introduction to PovcalNet Update</a></li>
<li><a class="" href="prepare.html"><span class="header-section-number">6</span> Prepare data for PovcalNet update</a></li>
<li><a class="" href="lis-data.html"><span class="header-section-number">7</span> LIS Data</a></li>
<li><a class="" href="primus.html"><span class="header-section-number">8</span> PRIMUS</a></li>
<li><a class="" href="update-microdata.html"><span class="header-section-number">9</span> Update microdata in the P drive</a></li>
<li><a class="" href="group-data.html"><span class="header-section-number">10</span> Group Data</a></li>
<li><a class="active" href="create-pcb-files.html"><span class="header-section-number">11</span> Create .PCB files</a></li>
<li><a class="" href="DMSystem.html"><span class="header-section-number">12</span> The Data Management System</a></li>
<li><a class="" href="master-file.html"><span class="header-section-number">13</span> Update the Master file</a></li>
<li class="book-part">Miscellaneous</li>
<li><a class="" href="referencing-software-zotero.html"><span class="header-section-number">14</span> Referencing software: Zotero</a></li>
<li><a class="" href="data-visualization-flourish-studio.html"><span class="header-section-number">15</span> Data visualization: Flourish studio</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="work-expectations.html"><span class="header-section-number">A</span> Quality of work expectations</a></li>
<li><a class="" href="kihoons-handover.html"><span class="header-section-number">B</span> Kihoon’s Handover</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/PovcalNet-Team/Povcalnet_internal_guidelines/">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="create-pcb-files" class="section level1" number="11">
<h1>
<span class="header-section-number">11</span> Create .PCB files<a class="anchor" aria-label="anchor" href="#create-pcb-files"><i class="fas fa-link"></i></a>
</h1>
<p>As explained in the <a href="intro-povcal.html#intro-povcal">introduction</a> of this part of the book,
creating the .PCB files is the last step of the process before uploading
everything to the PovcalNet system.</p>
<div id="what-the-heck-is-a-pcb-file" class="section level2" number="11.1">
<h2>
<span class="header-section-number">11.1</span> What the heck is a PCB file?!!<a class="anchor" aria-label="anchor" href="#what-the-heck-is-a-pcb-file"><i class="fas fa-link"></i></a>
</h2>
<p>PCB files are only relevant for micro-data. They basically store the micro-data
<code>welfare</code> and <code>weight</code> vectors, as well as pre-computed statistics. They are
custom binary files (data is stored as a bunch of 0s and 1s) that were created
to support the computations in PovcalNet. It is not a standard file format like
<code>.csv</code> or <code>.dta</code>.</p>
<p>They are used because they:</p>
<ul>
<li>Take less space</li>
<li>Can be read more efficiently</li>
</ul>
<p>PCB files contain four pieces of information:</p>
<ul>
<li>
<p>Metadata</p>
<ul>
<li>The PCB ID number. There are actually two types of .PCB files, an old
and a new format. The ID number is a way to differentiate them.</li>
<li>The number of microdata records</li>
<li>The number of points on the Lorenz curve</li>
</ul>
</li>
<li><p>Lorenz Curve</p></li>
<li><p>Pre-computed statistics<br>
Statistics that need to be computed only once (i.e. not on-the-fly, since
they are not sensitive to the poverty line)</p></li>
<li><p>Microdata</p></li>
</ul>
<div class="figure">
<img src="images/pcb_8202.PNG" alt=""><p class="caption">PCB file represention</p>
</div>
</div>
<div id="the-povcalnet_update-repository" class="section level2" number="11.2">
<h2>
<span class="header-section-number">11.2</span> The povcalnet_update repository<a class="anchor" aria-label="anchor" href="#the-povcalnet_update-repository"><i class="fas fa-link"></i></a>
</h2>
<p>Once you have updated all the sheets in the master file–besides the
“SurveyMean” sheet–and have updated the microdata in the P drive, the next step
is to create the .pcb files and update the “SurveyMean” sheet. All of this is
done with the
<a href="https://github.com/PovcalNet-Team/povcalnet_update">PovcalNet-Team/povcalnet_update</a>
repository. Make sure you clone the repo and open it as a <a href="https://martinctc.github.io/blog/rstudio-projects-and-working-directories-a-beginner's-guide/">project in
Rstudio</a>.
You will find the project has three .R files only. If everything goes as
expected, you’ll only need to use the file <em>00.master.R</em>.</p>
<p>In rare cases, you will need to modify the functions in the other two files. The
<em>utils.R</em> file has generic functions such as loading the master file into the
system, or creating survey IDs. These functions are used all along the process.
The <em>process_functions.R</em> file contains functions for specific parts of the
projects which are executed usually once along the whole process. Basically, the
<em>00.master.R</em> calls these functions in order in the same way that a master
do-file calls other do-files that do specific things.</p>
<p>In this chapter, we break down the <em>00.master.R</em> file, so you understand how to
run it, the logic behind, and what to do in case it needs to be fixed. Let’s
start by installing the minimum necessary packages. The <em>00.master.R</em> file
assumes you already have them installed, so you should run the code below before
you start.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># pkg_load &lt;- knitr::combine_words(pkgs, before = "`")</span>
<span class="va">pkgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"janitor"</span>, <span class="st">"data.table"</span>, <span class="st">"tidyverse"</span>, <span class="st">"writexl"</span>, <span class="st">"readxl"</span>, <span class="st">"here"</span>, <span class="st">"devtools"</span><span class="op">)</span>
<span class="va">no_installed</span> <span class="op">&lt;-</span> <span class="va">pkgs</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="va">pkgs</span>  <span class="op">%in%</span>  <span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span><span class="op">(</span><span class="va">no_installed</span><span class="op">)</span></code></pre></div>
</div>
<div id="generate-the-.pcb-files" class="section level2" number="11.3">
<h2>
<span class="header-section-number">11.3</span> Generate the .pcb files<a class="anchor" aria-label="anchor" href="#generate-the-.pcb-files"><i class="fas fa-link"></i></a>
</h2>
<div id="directories" class="section level3" number="11.3.1">
<h3>
<span class="header-section-number">11.3.1</span> Directories<a class="anchor" aria-label="anchor" href="#directories"><i class="fas fa-link"></i></a>
</h3>
<p>The first section includes the directories in which you’re going to be working.
As of today (2020-11-20), the <code>datadir</code> directory is for <code>2020_JUL</code> as it was
the last release of PovcalNet. However, make sure you create a new folder with
the year and month of the “tentative” release.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">datadir</span>   <span class="op">&lt;-</span> <span class="st">"p:/01.PovcalNet/02.Production/2020_JUL/"</span>
<span class="va">cpi_path</span>  <span class="op">&lt;-</span> <span class="st">"p:/01.PovcalNet/01.Vintage_control/_aux/price_framework/price_framework.dta"</span>
<span class="va">sheet</span>     <span class="op">&lt;-</span> <span class="st">"SurveyMean"</span>
<span class="va">mdir</span>      <span class="op">&lt;-</span> <span class="st">"p:/01.PovcalNet/00.Master/"</span></code></pre></div>
</div>
<div id="init-params" class="section level3" number="11.3.2">
<h3>
<span class="header-section-number">11.3.2</span> Surveys that have changed<a class="anchor" aria-label="anchor" href="#init-params"><i class="fas fa-link"></i></a>
</h3>
<p>Now, we have to specify what countries/years have been added or changed to the
PovcalNet repository. We recommend you do this country by country.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#--------- to modify in each round ---------</span>
<span class="va">countries</span> <span class="op">&lt;-</span> <span class="st">"CHN"</span>
<span class="va">years</span>     <span class="op">&lt;-</span> <span class="cn">NULL</span></code></pre></div>
<p>If you leave the argument <code>years</code> equal to <code>NULL</code>, the code will update all the
years for the country select. In this case, CHN. However, you could
specify what years to update for that particular country, like,</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">countries</span> <span class="op">&lt;-</span> <span class="st">"IND"</span>
<span class="va">years</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1993</span>, <span class="fl">2004</span>, <span class="fl">2009</span>, <span class="fl">2012</span><span class="op">)</span></code></pre></div>
<p>It is important to note that <em>unless you want to update all the years available</em>
in more than one country, you should not include in the <code>countries</code> variable
more than one country.</p>
</div>
<div id="prepare-metadata" class="section level3" number="11.3.3">
<h3>
<span class="header-section-number">11.3.3</span> Prepare metadata<a class="anchor" aria-label="anchor" href="#prepare-metadata"><i class="fas fa-link"></i></a>
</h3>
<p>In the next part we prepare the data. Function <code>pcn_datafind</code> finds the
directory path and filenames of the corresponding countries in variable
<code>countries</code>. It returns a list with two objects, <code>fail</code> and <code>pcn</code>. Object <code>fail</code>
lets you know if there is any particular data that could not be loaded. Object
<code>pcn</code> contains a data frame with the metadata of the countries and years
selected above.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Find countries</span>
<span class="va">tmp</span>       <span class="op">&lt;-</span> <span class="fu">pcn_datafind</span><span class="op">(</span>country <span class="op">=</span> <span class="va">countries</span><span class="op">)</span>
<span class="va">pcn_fails</span> <span class="op">&lt;-</span> <span class="va">tmp</span><span class="op">$</span><span class="va">fail</span>
<span class="va">pcn</span>       <span class="op">&lt;-</span> <span class="fu">as.data.table</span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">pcn</span><span class="op">)</span>

<span class="co"># Fix metadata</span>
<span class="va">pcn</span>       <span class="op">&lt;-</span> <span class="fu">fix_metadata</span><span class="op">(</span><span class="va">pcn</span><span class="op">)</span>

<span class="co"># Get reference year</span>
<span class="va">pcn</span>       <span class="op">&lt;-</span> <span class="fu">get_ref_year</span><span class="op">(</span><span class="va">pcn</span>, <span class="va">cpi_path</span><span class="op">)</span></code></pre></div>
<p>Then <code>pcn</code> object is then passed to the <code>fix_metadata</code> function in which some
columns like welfare type and survey coverage are added. Finally, function
<code>get_ref_year</code> merges the price framework data from <code>datalibweb</code> to assign the
right reference year to each survey. Keep in mind that the <code>get_ref_year()</code>
function makes some <em>hard-coded</em> adjustments that could not be identified
programmatically. That is, they follow ad-hoc rules to be included into (or
excluded from) the final Povcalnet inventory. One of the most problematic rules
is the correct assignment of the reference year to the survey-ID year. Check
those those cases if the resulting reference year is incorrect.</p>
</div>
<div id="generate-.pcb-files" class="section level3" number="11.3.4">
<h3>
<span class="header-section-number">11.3.4</span> Generate .pcb files<a class="anchor" aria-label="anchor" href="#generate-.pcb-files"><i class="fas fa-link"></i></a>
</h3>
<p>Now that the metadata is ready, we can create the .pcb file. This is done with
this code,</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="create-pcb-files.html#cb42-1"></a><span class="co"># -------------------- Create PCB --------------------</span></span>
<span id="cb42-2"><a href="create-pcb-files.html#cb42-2"></a>replace_file &lt;-<span class="st"> </span><span class="ot">TRUE</span></span>
<span id="cb42-3"><a href="create-pcb-files.html#cb42-3"></a>pcb_status &lt;-<span class="st"> </span></span>
<span id="cb42-4"><a href="create-pcb-files.html#cb42-4"></a><span class="st">  </span><span class="kw">generate_pcb_files</span>(<span class="dt">df          =</span> pcn, </span>
<span id="cb42-5"><a href="create-pcb-files.html#cb42-5"></a>                    <span class="dt">countries    =</span> countries,</span>
<span id="cb42-6"><a href="create-pcb-files.html#cb42-6"></a>                    <span class="dt">years        =</span> years, </span>
<span id="cb42-7"><a href="create-pcb-files.html#cb42-7"></a>                    <span class="dt">replace_file =</span> replace_file,</span>
<span id="cb42-8"><a href="create-pcb-files.html#cb42-8"></a>                    <span class="dt">datadir      =</span> datadir</span></code></pre></div>
<p>The function <code>generate_pcb_files</code> takes the directory paths of the microdata in
the <code>pcn</code> object, loads the microdata, and, inside the <code>datadir</code> directory,
creates the .pcb file into the <code>/01.pcb/</code> subdirectory and and .rds file (R
readable) into the <code>/02.rds/</code> sub-directory. The creation of the .rds is for
convenience. It allows you to check the data in the .pcb in an easy way. The
.pcb file, in contrast, is harder to read directly in R. Except for the file
format, two files are identical.</p>
<p>One feature of the <code>generate_pcb_files</code> function is that you can add additional
filters by country and year. By default, only the <code>years</code> objects defined
<a href="create-pcb-files.html#init-params">above</a> is being used until this point. In fact, you could create
another object, say <code>countries2</code>, and parse it into the argument <code>countries</code> of
the <code>generate_pcb_files</code> function.</p>
<p>Up to this point, the generation of the .pcb files is concluded, but the
PovcalNet system requires two types of inputs, welfare data and the master file.
We still need to update the “SurveyMean” sheet of the Master file.</p>
</div>
</div>
<div id="master-objectives" class="section level2" number="11.4">
<h2>
<span class="header-section-number">11.4</span> Update the Master file<a class="anchor" aria-label="anchor" href="#master-objectives"><i class="fas fa-link"></i></a>
</h2>
<p>Updating the Master file is the most challenging part of the whole process
because we need to make sure that,</p>
<ol style="list-style-type: decimal">
<li>whatever is correct <strong>must remain</strong> correct.</li>
<li>whatever is wrong should be fixed</li>
<li>whatever is not necessary should be removed</li>
<li>whatever is missing should be added</li>
<li>whatever is duplicated <strong>must be</strong> unified.</li>
</ol>
<p>Thus, we recommend that you run this sections one by one and check the results
in between. This is specially important for countries with urban/rural coverage
like China, India, or Indonesia; for countries with lagging reference years like
EU-SILC countries, or for tricky countries like … (Macedonia?).</p>
<div id="updatint-the-surveymean-sheet" class="section level3" number="11.4.1">
<h3>
<span class="header-section-number">11.4.1</span> Updatint the “SurveyMean” sheet<a class="anchor" aria-label="anchor" href="#updatint-the-surveymean-sheet"><i class="fas fa-link"></i></a>
</h3>
<p>The first step is to extract some important metadata information from the .rds
files generated in the previous step. This is done with the following code,</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lf</span> <span class="op">&lt;-</span> 
  <span class="fu">update_master_info</span><span class="op">(</span>df       <span class="op">=</span> <span class="va">pcn</span>, 
                    countries <span class="op">=</span> <span class="va">countries</span>,
                    years     <span class="op">=</span> <span class="va">years</span><span class="op">)</span>
<span class="va">st</span> <span class="op">&lt;-</span> <span class="va">lf</span><span class="op">$</span><span class="va">s</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="va">lf</span><span class="op">$</span><span class="va">df</span>

<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="va">status</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">st</span>, <span class="va">status</span> <span class="op">!=</span> <span class="st">"OK"</span><span class="op">)</span></code></pre></div>
<p>The object <code>lf</code> is a list with two objects, <code>st</code> and <code>df</code>. Object <code>st</code> is merely
the status of each survey in the <code>update_master_info</code> process, whereas <code>df</code> is
the actual metadata of the <em>new data</em>. Now, the following code loads the data in
the most recent version of the Master file,</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lmf</span>     <span class="op">&lt;-</span> <span class="fu">load_masterfile</span><span class="op">(</span><span class="op">)</span>
<span class="va">mf</span>      <span class="op">&lt;-</span> <span class="va">lmf</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">SurveyMean</span>

<span class="va">reg_ctry</span> <span class="op">&lt;-</span> <span class="va">lmf</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">CountryList</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span>
    Region      <span class="op">=</span> <span class="va">WBRegionCode</span>, 
    CountryCode <span class="op">=</span> <span class="va">CountryCode</span>, 
    countryName <span class="op">=</span> <span class="va">CountryName</span>
  <span class="op">)</span></code></pre></div>
<p>The function <code>load_masterfile</code> returns a list that is then bound to the name
<code>lmf</code> (this function takes a while to run especially if you’re working
remotely). The main object of <code>lmf</code> is another list, <code>data</code>, that contains a
data frame per sheet. So, in the code above, you’re creating object <code>mf</code> with
the “SurveyMean” and <code>red_ctry</code>, with the “CountryList” sheet. The reason why we
load the whole master file is that, when we create a new version we want that
version to include all the sheets, even those that were not modified. Function
<code>writexl::write_xls</code>, which is the function that saves the new version of the
master file, uses a list with all the sheets to save the file.</p>
<p>Now, we need to organize the new information into the “SurveyMean” format. This
is done with function <code>survey_mean_info</code>. However, and this one of the tricky
parts, we need to make sure that the <a href="create-pcb-files.html#master-objectives">five objectives above</a>
are met when we include the information of the new data. The <code>survey_mean_info</code>
function handles all the generic cases, but there are some cases that need to be
removed manually. This is why we have the object <code>condition</code> that goes directly
as one of the arguments of <code>survey_mean_info</code>. If it is necessary to manage any
special cases, this object should be set to an empty string, <code>condition &lt;- ""</code>.
Let’s see some examples of real cases in which we had to use the object
<code>condition</code>.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">condition</span> <span class="op">&lt;-</span> <span class="st">'!(countrycode == "IND" &amp; year == 2012)'</span></code></pre></div>
<p>In this case, we needed to remove the observation for India 2012, because even
though the <code>CPI_Time</code> variable in the master file is 2012, the <code>SurveyTime</code>
variable is 2011.5.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">condition</span> <span class="op">&lt;-</span> <span class="st">'!(countrycode == "CHN" &amp; grepl("A$", module))'</span></code></pre></div>
<p>Here we needed to remove all the observations of China for which the module
finished in a letter A.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">condition</span> <span class="op">&lt;-</span> <span class="st">'!(countrycode == "CHN" &amp; year &gt;= 1990 &amp; welfaretype3 == "y")'</span></code></pre></div>
<p>Here, there was a problem in the metadata and we needed to remove all the
observations for China after 1990 for which the welfare type was coded as
income, when in reality it was consumption.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">condition</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'!(countrycode  %in% '</span>, 
                    <span class="fu"><a href="https://rdrr.io/r/base/deparse.html">deparse</a></span><span class="op">(</span><span class="va">countries</span><span class="op">)</span>,
                    <span class="st">' &amp; year  %in%  '</span>, 
                    <span class="fu"><a href="https://rdrr.io/r/base/deparse.html">deparse</a></span><span class="op">(</span><span class="va">years</span><span class="op">)</span>,<span class="st">')'</span>
                    <span class="op">)</span></code></pre></div>
<p>This final example is a general form in which we remove old observations for all
the countries and years for which there is new data. This is very useful if we
want to start a country from scratch.</p>
<p>Now, we just need to identify the data that remains unchanged in the
“SurveyMean” sheet using the function <code>unchanged_data()</code> and then append
together the new data, <code>dfn,</code> and the <code>unchanged</code> data. Finally, we update the
Master file using the function <code>update_master_file</code>, which receives four
arguments, <code>lmf</code>, the current version of the master file with all its sheets;
<code>vintage</code>, the vintage control sheet which is loaded separately and it is useful
only for institutional-memory purposes; <code>new_mf</code>, which is the new “SurveyMean”
sheet with unchanged and new data; and <code>mdir</code>, which is the directory of the
master file.</p>
<p>You should be fine if you execute all these steps one by one, while checking the
intermediate outputs.</p>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="group-data.html"><span class="header-section-number">10</span> Group Data</a></div>
<div class="next"><a href="DMSystem.html"><span class="header-section-number">12</span> The Data Management System</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#create-pcb-files"><span class="header-section-number">11</span> Create .PCB files</a></li>
<li><a class="nav-link" href="#what-the-heck-is-a-pcb-file"><span class="header-section-number">11.1</span> What the heck is a PCB file?!!</a></li>
<li><a class="nav-link" href="#the-povcalnet_update-repository"><span class="header-section-number">11.2</span> The povcalnet_update repository</a></li>
<li>
<a class="nav-link" href="#generate-the-.pcb-files"><span class="header-section-number">11.3</span> Generate the .pcb files</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#directories"><span class="header-section-number">11.3.1</span> Directories</a></li>
<li><a class="nav-link" href="#init-params"><span class="header-section-number">11.3.2</span> Surveys that have changed</a></li>
<li><a class="nav-link" href="#prepare-metadata"><span class="header-section-number">11.3.3</span> Prepare metadata</a></li>
<li><a class="nav-link" href="#generate-.pcb-files"><span class="header-section-number">11.3.4</span> Generate .pcb files</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#master-objectives"><span class="header-section-number">11.4</span> Update the Master file</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#updatint-the-surveymean-sheet"><span class="header-section-number">11.4.1</span> Updatint the “SurveyMean” sheet</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/PovcalNet-Team/Povcalnet_internal_guidelines//blob/master/pcb_files.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/PovcalNet-Team/Povcalnet_internal_guidelines//edit/master/pcb_files.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>PovcalNet Internal Guidelines and Protocols</strong>" was written by PovcalNet team, Development Data Group, World Bank Group. It was last built on 2021-01-08.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
